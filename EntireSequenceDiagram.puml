@startuml
title Order-Payment-Settlement-Notification Flow (with Order UseCase)

participant User
participant OrderController
participant PlaceOrderUseCase
participant OrderService
participant OrderRepository
participant "Order Outbox DB" as OrderOutboxDB
participant "Order Outbox Worker" as OrderOutboxWorker
participant Payment
participant PG
participant "Payment Outbox DB" as PayOutboxDB
participant "Payment Outbox Worker" as PayOutboxWorker
participant Settlement
participant "Settlement Outbox DB" as SettleOutboxDB
participant "Settlement Outbox Worker" as SettlementOutboxWorker
participant "RabbitMQ" as RabbitMQ
participant Notification
participant "Notification Outbox DB" as NotiOutboxDB
participant "Notification Outbox Worker" as NotiOutboxWorker
participant "Third Party e.g. FCM" as FCM


User -> OrderController : 0: POST /api/orders 결제 요청
OrderController -> PlaceOrderUseCase : 1: execute(dto)
PlaceOrderUseCase -> OrderService : 2: execute(dto)

activate OrderService

OrderService -> OrderRepository : 3: findByIdempotencyKey(dto.key)
OrderRepository --> OrderService : 4: not exists
note right of OrderService
5. save(OrderEntity)
6. INSERT PaymentRequestedEvent(status=PENDING)
이벤트 유실 방지를 위해서 같은 트랜잭션으로 저장
end note
OrderService -> OrderRepository : 5: save(OrderEntity)
OrderService -> OrderOutboxDB : 6: INSERT PaymentRequestedEvent(status=PENDING)

deactivate OrderService

' ================================
' 7~13: Order Outbox → RabbitMQ
' ================================
OrderOutboxWorker -> OrderOutboxDB : 7: SELECT status=PENDING
OrderOutboxDB --> OrderOutboxWorker : 8: Pending events
OrderOutboxWorker -> RabbitMQ : 9: publish PaymentRequestedEvent
RabbitMQ --> OrderOutboxWorker : 10: publish success callback
OrderOutboxWorker -> OrderOutboxDB : 11: UPDATE status=SENT

' ================================
' 14~22: Payment 도메인(PG 호출) + Outbox
' ================================
RabbitMQ -> Payment : 14: PaymentRequestedEvent

Payment -> PG : 15: 결제 요청
PG --> Payment : 16: 결제 성공 응답
Payment -> PayOutboxDB : 17: INSERT PaymentCompletedEvent(status=PENDING)

PayOutboxWorker -> PayOutboxDB : 18: SELECT status=PENDING
PayOutboxDB --> PayOutboxWorker : 19: Pending events
PayOutboxWorker -> RabbitMQ : 20: publish PaymentCompletedEvent
RabbitMQ --> PayOutboxWorker : 21: publish success callback
PayOutboxWorker -> PayOutboxDB : 22: UPDATE status=SENT

' ================================
' 23~29: Settlement 도메인 Outbox
' ================================
RabbitMQ -> Settlement : 23: PaymentCompletedEvent
Settlement -> SettleOutboxDB : 24: INSERT SettlementCompletedEvent(status=PENDING)

SettlementOutboxWorker -> SettleOutboxDB : 25: SELECT status=PENDING
SettleOutboxDB --> SettlementOutboxWorker : 26: Pending events
SettlementOutboxWorker -> RabbitMQ : 27: publish SettlementCompletedEvent
RabbitMQ --> SettlementOutboxWorker : 28: publish success callback
SettlementOutboxWorker -> SettleOutboxDB : 29: UPDATE status=SENT

' ================================
' 30~36: Notification 도메인 Outbox → FCM
' ================================
RabbitMQ -> Notification : 30: SettlementCompletedEvent
Notification -> NotiOutboxDB : 31: INSERT NotificationRequestedEvent(status=PENDING)

NotiOutboxWorker -> NotiOutboxDB : 32: SELECT status=PENDING
NotiOutboxDB --> NotiOutboxWorker : 33: Pending events
NotiOutboxWorker -> FCM : 34: 푸시 발송 요청
FCM --> NotiOutboxWorker : 35: 푸시 발송 성공
NotiOutboxWorker -> NotiOutboxDB : 36: UPDATE status=SENT

@enduml
