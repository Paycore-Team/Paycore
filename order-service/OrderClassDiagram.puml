@startuml
skinparam linetype ortho
package "Order Service" {
skinparam ranksep 120
skinparam nodesep 150

GetOrderService -[hidden]l-> OrderRequest
GetOrderService -[hidden]d-> JpaRepository
GetOrderRequest -[hidden]r-> OrderRequest

  class Order {
    +orderId: Long
    +idempotencyKey: UUID
    +apiKey: String
    +productDesc: String
    +amount: BigDecimal
    +amountTaxFree: Long
    +status: OrderStatus
    +createdAt: LocalDateTime
    +updateStatus(status: OrderStatus): void
  }

  enum OrderStatus {
    PENDING
    PAID
    CANCELLED
  }

  class OrderOutbox {
      +sagaId: UUID
      +orderId: Long
      +eventType: EventType
      +status: OutboxStatus
      +apiKey: String
      +productDesc: String
      +amount: BigDecimal
      +amountTaxFree: Long
      +createdAt: LocalDateTime
  }

  enum OutboxStatus {
      PENDING
      SENT
  }

  enum EventType {
      SUCCESS
      FAILURE
  }

  class OrderRequest {
      +idempotencyKey: UUID
      +apiKey: String
      +productDesc: String
      +amount: BigDecimal
      +amountTaxFree: Long
  }

  class GetOrderRequest {
    +orderId: Long
  }

  class GetOrderResponse {
    +order: Order
  }

  class OrderController {
    -orderService: OrderService
    -getOrderService: GetOrderService
    +createOrder(input: OrderRequest): Void
    +getOrder(input: GetOrderRequest): GetOrderResponse
  }

  interface UseCase<I, O> {
      +execute(input: I): O
  }

  interface OrderUseCase {
      +execute(input: OrderRequest): Void
  }

  interface GetOrderUseCase {
      +execute(input: GetOrderRequest): GetOrderResponse
  }

  class OrderService {
    -orderRepository: OrderRepository
    -orderOutboxRepository: OrderOutboxRepository
    +execute(input: OrderRequest): Void
  }

  class GetOrderService {
    -orderRepository: OrderRepository
    +execute(input: GetOrderRequest): GetOrderResponse
  }

  interface OrderRepository {
    + save(order: Order)
    + findById(orderId: Long): Optional<Order>
  }

  interface OrderOutboxRepository {
    + save(OrderOutbox event)
    + findUnsentEvents(): List<OrderOutbox>
    + markAsSent(orderId: Long): Void
  }

  JpaRepository <|-- OrderRepository
  JpaRepository <|-- OrderOutboxRepository

  Order "1" -- "1" OrderOutbox
  Order --> OrderStatus
  OrderOutbox --> OutboxStatus
  OrderOutbox --> EventType

  OrderController --> OrderService
  OrderController --> GetOrderService

  OrderUseCase -up-|> UseCase
  GetOrderUseCase -up-|> UseCase

  OrderUseCase <|.. OrderService
  GetOrderUseCase <|.. GetOrderService

  OrderService --> OrderRepository
  OrderService --> OrderOutboxRepository
  GetOrderService --> OrderRepository
}
@enduml
