@startuml
skinparam linetype ortho
skinparam sequenceMessageAlign center

participant User
participant OrderController
participant "PlaceOrderUseCase" as PlaceOrderUseCase
participant "OrderService" as OrderService
participant "OrderEntity + OrderOutboxEntity" as DB
participant "OrderOutboxWorker" as OrderOutboxWorker

== 주문 생성 요청 ==

User -> OrderController : 1. POST /api/orders\n(OrderRequestDto)

OrderController -> PlaceOrderUseCase : 1.1 execute(dto)

PlaceOrderUseCase -> OrderService : 1.2 execute(dto)

== Idempotency Check ==

OrderService -> DB : 1.3 findByIdempotencyKey(dto.key)
DB --> OrderService : 1.4 existing order or null

alt 기존 주문 존재
    OrderService --> OrderController : 1.5 기존 주문 상태 반환
else 신규 주문
    == 주문 생성 ==
    OrderService -> DB : 2. OrderEntity 저장\n(status = PENDING)

    == Outbox 기록 ==
    OrderService -> DB : 2.1 OrderOutboxEntity 저장\n(eventType = PaymentRequested,\nstatus = PENDING)

    note right of OrderService
    2 와 2.1 은
    동일 트랜잭션(@Transactional)
    end note

    OrderService --> OrderController : 2.2 주문 상태 반환
end

== Outbox Worker 시작 ==

OrderOutboxWorker -> DB : 3. 처리되지 않은 Outbox 조회
DB --> OrderOutboxWorker : 4. Outbox 레코드 반환

OrderOutboxWorker -> DB : 5. Outbox 상태 업데이트\n(status = SENT)

@enduml
