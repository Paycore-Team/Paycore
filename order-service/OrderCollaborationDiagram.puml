@startuml
skinparam linetype ortho
top to bottom direction

skinparam ranksep 100
skinparam nodesep 280

' 객체(노드) 정의
object User
object OrderService
object "OrderEntity\n(Order)" as OrderEntity
object "OrderOutboxEntity\n(Outbox)" as OrderOutbox
object OrderOutboxWorker
object RabbitMQ

User -[hidden]r-> OrderService
OrderService -[hidden]d-> OrderEntity
OrderService -[hidden]r-> OrderOutbox
OrderOutbox -[hidden]d-> OrderOutboxWorker
OrderOutboxWorker -[hidden]d-> RabbitMQ

' 메시지(번호 포함)
User -down-> OrderService      : 1. 주문 요청

' ---- 추가 시작 ----
OrderService -down-> OrderEntity : 1.1. idempotency key 존재 여부 조회
OrderEntity -down-> OrderService : 1.2. 기존 레코드 존재 시 결과 반환
OrderService -down-> User        : 1.3. 기존 주문 결과 반환

note top of OrderService
1.1 조회 결과가 있는 경우 -> 1.2, 1.3 수행 후 종료
1.1 조회 결과가 없는 경우 -> 2 이후 신규 주문 처리 수행
end note
' ---- 추가 끝 ----

' ---- 트랜잭션 묶음 표시 ----
OrderService -down-> OrderEntity : 2. 주문 데이터 저장(PENDING)
OrderService -down-> OrderOutbox : 2.1. Outbox 레코드 저장\n(event = PaymentRequested)

note top of OrderService
2와 2.1은 동일 트랜잭션에서 수행됨
end note
' ---- 추가 끝 ----

OrderOutboxWorker -down-> OrderOutbox : 3. 처리되지 않은 Outbox 조회
OrderOutbox -down-> OrderOutboxWorker : 4. Outbox 반환

OrderOutboxWorker -down-> RabbitMQ : 5. PaymentRequestedEvent 발행
RabbitMQ -down-> OrderOutboxWorker : 6. ACK

OrderOutboxWorker -down-> OrderOutbox : 7. Outbox 상태 = COMPLETED

@enduml
