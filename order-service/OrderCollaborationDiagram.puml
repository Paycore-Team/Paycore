@startuml
skinparam linetype ortho
top to bottom direction

skinparam ranksep 170
skinparam nodesep 260

' ======================
' 객체(노드) 정의
' ======================
object User
object OrderController
object "PlaceOrderUseCase\n(Port)" as PlaceOrderUseCase
object "OrderService\n(UseCase Impl)" as OrderService
object "OrderEntity\n(Order)" as OrderEntity
object "OrderOutboxEntity\n(Outbox)" as OrderOutbox
object "OrderOutboxWorker" as OrderOutboxWorker

' ======================
' 레이아웃 보정 (hidden)
' ======================
User -[hidden]d-> OrderController
OrderController -[hidden]d-> PlaceOrderUseCase
PlaceOrderUseCase -[hidden]d-> OrderService
OrderService -[hidden]d-> OrderEntity
OrderService -[hidden]r-> OrderOutbox
OrderOutbox -[hidden]d-> OrderOutboxWorker

' ======================
' 메시지 흐름
' ======================

User -down-> OrderController: 1. POST /api/orders (OrderRequestDto)

OrderController -down-> PlaceOrderUseCase: 1.1 execute(dto)

PlaceOrderUseCase -down-> OrderService: 1.2 execute(dto)

' ---- Idempotency Check ----
OrderService -down-> OrderEntity: 1.3 findByIdempotencyKey(dto.key)

OrderEntity -down-> OrderService: 1.4 existing order or null

OrderService -up-> OrderController: 1.5 return existing OrderStatus (if exists)

note right of OrderService
1.3 결과가 존재하면
→ 신규 주문 처리 없이 바로 반환
end note

' ---- 신규 주문 처리 ----
OrderService -down-> OrderEntity: 2. save Order (status=PENDING)

OrderService -down-> OrderOutbox: 2.1 save Outbox\n(PaymentRequestedEvent)

note right of OrderService
2 와 2.1 은
동일 트랜잭션(@Transactional)
end note

OrderService -up-> OrderController: 2.2 return OrderStatus

' ---- Outbox Worker 처리 ----
OrderOutboxWorker -down-> OrderOutbox: 3. PENDING 상태 Outbox 조회

OrderOutbox -down-> OrderOutboxWorker: 4. Outbox 이벤트 반환

@enduml
